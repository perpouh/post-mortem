(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{428:function(t,s,a){"use strict";a.r(s);var n=a(53),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"github-actionsで自動テストをやる"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#github-actionsで自動テストをやる"}},[t._v("#")]),t._v(" Github Actionsで自動テストをやる")]),t._v(" "),a("p",[t._v("プルリクエストが作成されたら→rubocopとrspecを走らせる。")]),t._v(" "),a("p",[t._v("rubocopは正直pre-commit辺りに仕込んでもいいのだけどpre-commitは共有されないから厳しい。"),a("br"),t._v("\n今回プロジェクトは私一人なので考える必要無いんですけどね。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://medium.com/@astatsuya/7156def39b64",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHooksのpre-pushを共有してレポジトリを健全に保つ - Tatsuya Asami - Medium"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"大まかな流れ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#大まかな流れ"}},[t._v("#")]),t._v(" 大まかな流れ")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("feature/gem-upgrade_YYMMDD")]),t._v("ブランチを作成する")]),t._v(" "),a("li",[a("code",[t._v("bundle update")]),t._v("を実行する")]),t._v(" "),a("li",[t._v("コミット、プッシュ")]),t._v(" "),a("li",[t._v("PRを作成する\n"),a("ol",[a("li",[t._v("PRを作成したらPRをフックにしている自動テストが走る（予定）")]),t._v(" "),a("li",[t._v("→workflowをhookにworkflowは動いてくれないようだったのでhookを追加")])])]),t._v(" "),a("li",[t._v("手動でマージし、ブランチを削除")])]),t._v(" "),a("p",[t._v("手動の作業が残っているのは気分的に一応目視確認したかっただけです。誤字脱字とかログの削除漏れとかはなぜかプッシュしてからブラウザで見た方が発見率が高い（当社比）ので。")]),t._v(" "),a("h2",{attrs:{id:"実際のコード"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実際のコード"}},[t._v("#")]),t._v(" 実際のコード")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pull_request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("branches")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" master "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workflow_run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workflows")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" scheduled_gem_update\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("branches")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'feature/gem-upgrade_**'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("types")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" completed\n")])])]),a("p",[t._v("前半はPRが作成されたときのためのもの、後半は自動で "),a("code",[t._v("bundle update")]),t._v(" したときのためのものです。現在はmasterブランチに対してPR送るときのみ自動テストにしていますが、そのうちdevelopブランチを生やしたらそっちにも仕掛ける予定です。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/checkout@v2\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Set up Ruby\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ruby/setup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ruby@21351ecc0a7c196081abca5dc55b08f085efe09a\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ruby-version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.6")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ImageOS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu18\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Install dependencies\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n        cd server\n        bundle install")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Run rubocop\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n        cd server\n        bundle exec rubocop")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Run tests\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RAILS_ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB_USER")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB_HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" localhost\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB_DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" post"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mortem_test\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("CLIENT_HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" www.example.com\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n        sudo /etc/init.d/mysql start\n        cd server\n        bundle exec rails db:create\n        bundle exec rails db:migrate\n        bundle exec rspec")]),t._v("\n")])])]),a("p",[a("code",[t._v("cd server")]),t._v(" とかはそうしないとコマンドの実行場所がおかしかったので不承不承で書いたものです。なんか美しくないから嫌なんだけど、こういうものかしら。")]),t._v(" "),a("p",[a("code",[t._v("Run tests")]),t._v(" jobのenvについて。"),a("br"),t._v("\nソースを変えずに環境変数だけ変えてローカルもテストも本番も動くようにしたかったので、"),a("code",[t._v("database.yml")]),t._v(" は以下のようになっています。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&default")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("adapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql2\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' <%= ENV.fetch("RAILS_MAX_THREADS") '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("charset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" utf8mb4\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("encoding")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" utf8mb4\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("collation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" utf8mb4_general_ci\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <%= ENV"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DB_USER'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <%= ENV"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DB_PASSWORD'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("database")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <%= ENV"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DB_DATABASE'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <%= ENV"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DB_HOST'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("この "),a("code",[t._v("<%= ENV['hoge'] %>")]),t._v(" のところに、例えばdocker-composeの設定値だとか、ワークフローの設定値だとか、パラメータストアの設定値が入ってきます。")]),t._v(" "),a("h2",{attrs:{id:"テストはテストの設定で動くようにする"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#テストはテストの設定で動くようにする"}},[t._v("#")]),t._v(" テストはテストの設定で動くようにする")]),t._v(" "),a("p",[t._v("これが何かって言うと、開発環境とは別にテスト環境を作りたいという話です。どっちも仮想ですけど。"),a("br"),t._v("\ntestの方はテストが終わったらすべてのデータが削除され、毎回必ずまっさらの状態からのテストになります。対する開発環境は、いちいちユーザーデータとか消えたらかったるいどころではないので、永続化します。")]),t._v(" "),a("p",[t._v("GithubActionsおよびコンソールの "),a("code",[t._v("docker-compose run --rm server rspec")]),t._v(" コマンドで動くのはtestの設定。"),a("code",[t._v("docker-compose up")]),t._v(" で動くのはdevelopになるようにします。"),a("br"),t._v("\nとはいえ "),a("code",[t._v("rails_helper.rb")]),t._v(" に"),a("code",[t._v("ENV['RAILS_ENV'] = 'test'")]),t._v("と書いて無理やりtestで動かしてるだけです。問題が起きたらそれはその時。")])])}),[],!1,null,null,null);s.default=e.exports}}]);